<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>Upvote</title>
    <style>
        .people_counter {
          text-align:center;
        }
    </style>
  </head>
  <body>
    <div style="width:100%; text-align:center;">
      <canvas id="draw" height="500" width="1000" style="border: 1px solid #111111; margin: auto"/>
    </div>
    <div id="errors">
      <div id="too_many_people"></div>
      <div id="too_many_hands"></div>
    </div>
    <div id="num_raised"></div>
    <img class="twod"/>
    <div class = "people_counter"></div>
    <div class = "error-ctx"></div>
    <div class="countdown"> One </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tinycolor/1.4.1/tinycolor.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js" type="text/javascript"></script>
    <script type="text/javascript">
      var host = "cpsc484-02.yale.internal:8888";
      
      $(document).ready(function() {
        PLAYING = false; 
          frames.start();
          twod.start();
      });
      var RAISED = false;
      var timer = 0; 
      var num_people_raised = 0;

      var frames = {
        socket: null,

        start: function() {
          var url = "ws://" + host + "/frames";

          // canvas object
          var c = document.getElementById("draw");
          var ctx = c.getContext("2d");
          // all real-world units are in mm unless denoted by CM
          var personRadiusCM = 30;
          // origin (x,y)
          var origin = [c.width/2, 0];

          // subscribe to the /frames data
          frames.socket = new WebSocket(url);
          frames.socket.onmessage = function(event) {
            let data = JSON.parse(event.data);
            // clear the canvas
            ctx.clearRect(0, 0, c.width, c.height);
            // Insert code so that by default, the screen shows a message 
            
            // draw the camera on the top of the screen

            drawEnv(ctx, origin);
            
            if (data.people) {
              ctx.clearRect(0, 0, c.width, c.height);
              var num_people = Object.keys(data.people).length;
              $('.people_counter').text(`I see ${num_people} people`);
              // if (num_people > 1){
              //   document.getElementById("errors").innerHTML = "Please only one player in front of the screen";
              // }
              //console.log(num_people);
              for (const [idx, person] of Object.entries(data.people)) {
                var hand_raised = 0;
                // we want the data on the x,z plane from the camera's frame, so use indicies and 0 (x), 2 (Z)
                // see: https://developer.mozilla.org/en-US/docs/Web/API/Canvas_API/Tutorial/Drawing_shapes#arcs
                // function definition is: arc(x, y, radius, startAngle, endAngle, counterclockwise)
                ctx.strokeStyle = ctx.fillStyle = colors[i++];
                ctx.beginPath();
                // Code to detect where the person is, relative to the middle of the display 
                // const POSITIONS = {
                //   LEFT : "left",
                //   RIGHT: "right"
                // }

                
                // If a person is raising both hands, give error message to raise only one hand
                if (person.joints[7].position.y <= person.joints[28].position.y && person.joints[14].position.y <= person.joints[30].position.y) {
                  document.getElementById("too_many_hands").innerHTML = "Please raise only one hand";
                  ctx.fillStyle = 'red';
                  ctx.font = "25px Calibri";
                  ctx.fillText("Please raise only one hand", ctx.canvas.clientWidth/5, ctx.canvas.clientHeight*7/8);
                }
                // If only person's left hand is raised above left eye, shade left side grey
                else if (person.joints[7].position.y <= person.joints[28].position.y && person.joints[14].position.y > person.joints[30].position.y) { 
                  // Here, the person is standing on the left 
                  POSITION = "left" ;
                  // if(num_people_raised == 0){
                  //   RAISED = false 
                  // }
                  if(RAISED == false){
                    // FIrst occurence of this happening 
                    timer = Date.now();
                  }
                  RAISED = true;
                  var time_left = (Date.now()/1000) - (Math.floor(timer/1000)); 
                  ctx.fillStyle = 'grey';
                  ctx.fillRect(0, 0, ctx.canvas.clientWidth/2, ctx.canvas.clientHeight);
                  ctx.arc(ctx.canvas.clientWidth/2, 200, 50,0, 2 * Math.PI); 
                  ctx.fillStyle = '#333333';
                  ctx.fillRect(ctx.canvas.clientWidth*2/5, 0, ctx.canvas.clientWidth/5, ctx.canvas.clientHeight/6);

                  ctx.font = "25px Calibri";
                  time_left = 5 - Math.floor(time_left);
                  if(time_left >=0){ctx.fillText(time_left.toString(), ctx.canvas.clientWidth/2, 200);}
                  ctx.fillText("Option 1", ctx.canvas.clientWidth/5, ctx.canvas.clientHeight*4.5/8);
                  ctx.fillText("Option 2", ctx.canvas.clientWidth*7/10, ctx.canvas.clientHeight*4.5/8);
                  ctx.fillStyle = "#FFFFFF";
                  ctx.fillText("Upvote!", ctx.canvas.clientWidth*9.2/20, ctx.canvas.clientHeight/10);
                  // console.log((Date.now()/1000) - (Math.floor(timer/1000)) );
                  hand_raised = 1;
                  
                  $('.countdown').text(`${5 - Math.floor(time_left)} seconds left`); 
                  if((Date.now()/1000) - (Math.floor(timer/1000) ) >= 5){
                      // 5 Seconds elapsed 
                      console.log("5 seconds");
                  $('.countdown').text("Done!");
                  ctx.fillStyle = 'green';
                  ctx.fillRect(0, 0, ctx.canvas.clientWidth/2, ctx.canvas.clientHeight);
                  ctx.fillStyle = '#333333';
                  ctx.fillRect(ctx.canvas.clientWidth*2/5, 0, ctx.canvas.clientWidth/5, ctx.canvas.clientHeight/6);

                  ctx.font = "25px Calibri";
                  ctx.fillText("Option 1", ctx.canvas.clientWidth/5, ctx.canvas.clientHeight*4.5/8);
                  ctx.fillText("Option 2", ctx.canvas.clientWidth*7/10, ctx.canvas.clientHeight*4.5/8);
                  ctx.fillStyle = "#FFFFFF";
                  ctx.fillText("Upvote!", ctx.canvas.clientWidth*9.2/20, ctx.canvas.clientHeight/10);

                  
                  }
                  
                  // startCountdown(5);
                  document.getElementById("too_many_hands").innerHTML = "";
                } 
                // Else if only person's right hand is raised above right eye, shade right side grey
                else if (person.joints[14].position.y <= person.joints[30].position.y && person.joints[7].position.y > person.joints[28].position.y) {
                  POSITION = "right"; 
                  // if(num_people_raised == 0){
                  //   RAISED = false 
                  // }
                  if(RAISED == false){
                    // FIrst occurence of this happening 
                    timer = Date.now();
                  }
                  RAISED = true;
                  var time_left = (Date.now()/1000) - (Math.floor(timer/1000)); 
                  ctx.fillStyle = 'grey';
                  time_left = 5 - Math.floor(time_left);
                  ctx.fillRect(ctx.canvas.clientWidth/2, 0, ctx.canvas.clientWidth/2, ctx.canvas.clientHeight);
                  ctx.fillStyle = '#333333';
                  ctx.arc(ctx.canvas.clientWidth/2, 200, 50,0, 2 * Math.PI); 
                  
                  ctx.fillRect(ctx.canvas.clientWidth*2/5, 0, ctx.canvas.clientWidth/5, ctx.canvas.clientHeight/6);

                  ctx.font = "25px Calibri";
                  if(time_left >=0){ctx.fillText(time_left.toString(), ctx.canvas.clientWidth/2, 200);}
                  ctx.fillText("Option 1", ctx.canvas.clientWidth/5, ctx.canvas.clientHeight*4.5/8);
                  ctx.fillText("Option 2", ctx.canvas.clientWidth*7/10, ctx.canvas.clientHeight*4.5/8);
                  ctx.fillStyle = "#FFFFFF";
                  ctx.fillText("Upvote!", ctx.canvas.clientWidth*9.2/20, ctx.canvas.clientHeight/10);
                  hand_raised = 1;
                  // console.log((Date.now()/1000) - (Math.floor(timer/1000)) );
                  if((Date.now()/1000) - (Math.floor(timer/1000) ) >= 5){
                      // 5 Seconds elapsed 
                      console.log("5 seconds");
                  ctx.fillStyle = 'green';
                  ctx.fillRect(ctx.canvas.clientWidth/2, 0, ctx.canvas.clientWidth/2, ctx.canvas.clientHeight);
                  ctx.fillStyle = '#333333';
                  ctx.fillRect(ctx.canvas.clientWidth*2/5, 0, ctx.canvas.clientWidth/5, ctx.canvas.clientHeight/6);

                  ctx.font = "25px Calibri";
                  ctx.fillText("Option 1", ctx.canvas.clientWidth/5, ctx.canvas.clientHeight*4.5/8);
                  ctx.fillText("Option 2", ctx.canvas.clientWidth*7/10, ctx.canvas.clientHeight*4.5/8);
                  ctx.fillStyle = "#FFFFFF";
                  ctx.fillText("Upvote!", ctx.canvas.clientWidth*9.2/20, ctx.canvas.clientHeight/10);
                  document.getElementById("too_many_hands").innerHTML = "";
                }
                }
                // $('.people_counter').text(`The person is at the ${POSITION} of the screen`);
                num_people_raised += hand_raised;
              }
              if (num_people_raised > 1){
                document.getElementById("too_many_people").innerHTML = "Please only one player raising their hand in front of the screen";
               
                ctx.fillStyle = 'red';
                ctx.font = "25px Calibri";
                ctx.fillText("Too many people raising their hand in front of the screen", ctx.canvas.clientWidth/5, ctx.canvas.clientHeight*7/8);
              }
              else {
                document.getElementById("too_many_people").innerHTML = "";
                drawEnv(ctx, origin);
              }
            }
            document.getElementById("num_raised").innerHTML = num_people_raised;
            num_people_raised = 0;
          }
        }
      };

      var twod = {
        socket: null,

        // create a connection to the camera feed
        start: function () {
            var url = "ws://" + host + "/twod";
            twod.socket = new WebSocket(url);

            // whenever a new frame is received...
            twod.socket.onmessage = function (event) {

                // parse and show the raw data
                twod.show(JSON.parse(event.data));
            }
        },

        // show the image by adjusting the source attribute of the HTML img object previously created
        show: function (twod) {
            $('img.twod').attr("src", 'data:image/pnjpegg;base64,' + twod.src);
        },
      };


      // Helper Functions

      // Countdown
      // function startCountdown(seconds) {
      //   let counter = seconds;
      //   ctx.fillText(counter, ctx.canvas.clientWidth*9.2/20, ctx.canvas.clientHeight/2);
          
      //   const interval = setInterval(() => {
      //     console.log(counter);
      //     counter--;

      //     if (counter < 0 ) {
      //       clearInterval(interval);
      //     }
      //   }, 1000);
      // }

      //

      // Convert MM to CM
      // function toCM(mm) {
      //   return mm/10;
      // }

      // Setup an array of colors
      var tc = tinycolor({
        r: Math.floor(Math.random() * 0xFF),
        g: Math.floor(Math.random() * 0xFF),
        b: Math.floor(Math.random() * 0xFF)
      });
      colors = [];
      var parts = 2 + Math.floor(Math.random() * 5);
      for (var i = 0; i < parts; i++) {
        tc = tc.spin(360 / parts);
        colors.push('#' + tc.toHex());
      }
      function drawIntro(ctx, origin){
        ctx.strokeStyle = "blue"; 
        ctx.fillStyle = 'white';
        ctx.font = "25px Calibri";
        ctx.fillRect(0, 0, ctx.canvas.clientWidth, ctx.canvas.clientHeight); 
        ctx.fillStyle = 'red';
        ctx.fillText("Hey, wanna play a cool game? Raise your hand and start", ctx.canvas.clientWidth/5, ctx.canvas.clientHeight/2);
        
      }
      // Draw the environment
      function drawEnv(ctx, origin, time) {
        ctx.strokeStyle = "#333333";

        // middle line
        ctx.moveTo(ctx.canvas.clientWidth/2, ctx.canvas.clientHeight/10);
        ctx.lineTo(ctx.canvas.clientWidth/2, ctx.canvas.clientHeight);
        ctx.stroke();

        // Upvote box and instructions box
        ctx.fillStyle = 'darkblue';
        ctx.fillRect(ctx.canvas.clientWidth*2/5, 0, ctx.canvas.clientWidth/5, ctx.canvas.clientHeight/6);
        ctx.fillStyle = 'lightgrey';
        ctx.fillRect(ctx.canvas.clientWidth*2.4/20, ctx.canvas.clientHeight*1.7/10, ctx.canvas.clientWidth*6/8, ctx.canvas.clientHeight/12);

        // Options and instructions text
        ctx.font = "25px Calibri";
        ctx.fillStyle = '#333333';
        ctx.fillText("Option 1", ctx.canvas.clientWidth/5, ctx.canvas.clientHeight*4.5/8);
        ctx.fillText("Option 2", ctx.canvas.clientWidth*7/10, ctx.canvas.clientHeight*4.5/8);
        ctx.fillText("To select an option, raise either your left or right hand for 5 seconds", ctx.canvas.clientWidth*3.2/20, ctx.canvas.clientHeight*2.3/10);
        
        // Upvote and instructions text
        ctx.fillStyle = "#FFFFFF";
        ctx.fillText("Upvote!", ctx.canvas.clientWidth*9.2/20, ctx.canvas.clientHeight/10);
        
        

        ctx.beginPath();

      }

    </script>
  </body>
</html>
